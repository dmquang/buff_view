import requests, random, bs4, sys, re, base64, urllib.parse,datetime
from datetime import datetime
import time
import os
from datetime import date
from pystyle import *

os.system('cls')
__AUTHOR__ = 'DARLING'
__USING__= 'VIEW/SHARE TIKTOK'
__VERSION__ = '1.0'
__ZALO__= '0372760208'
__NOTE__ ='THANKS'
def banner():
    print(f''' 

\033[32;5;245m\033[1m\033[38;5;27m• • • • • • • • • • • • • • • • • • • • • •\033[1m\033[38;5;237m[\033[38;5;54m+\033[38;5;237m]  \033[4m\033[38;5;164mAuthor: {__AUTHOR__} \033[0m
\033[32;5;245m\033[1m\033[38;5;33m  _______  _____  __ _________      __ __  \033[1m\033[38;5;237m[\033[38;5;54m*\033[38;5;237m]  \033[4m\033[38;5;164mUsing: {__USING__}\033[0m
\033[32;5;245m\033[1m\033[38;5;39m(  _ \  /__\  (  _ \(  )  (_  _)( \( )/ __)  \033[1m\033[38;5;237m[\033[38;5;54m-\033[38;5;237m]  \033[4m\033[38;5;164mVersion: {__VERSION__}\033[0m
\033[32;5;245m\033[1m\033[38;5;45m )(_) )/(__)\  )   / )(__  _)(_  )  (( (_-.   \033[1m\033[38;5;237m[\033[38;5;54m*\033[38;5;237m]  \033[4m\033[38;5;164mDonate: {__ZALO__}\033[0m 
\033[32;5;245m\033[1m\033[38;5;51m(____/(__)(__)(_)\_)(____)(____)(_)\_)\___/    \033[1m\033[38;5;237m[\033[38;5;54m+\033[38;5;237m]  \033[4m\033[38;5;164mNote: {__NOTE__}\033[0m                                                                                         
     ''')
today = date.today()

ngay = today.year
thang = today.month
nam =  today.day
key = f"vbv{nam}2{ngay}84{thang}24"
dau=" ~ [✓] => "
#url_key = f"https://vanboss.000webhostapp.com/api_key/keytool.php?key={key}"

#api_url = f"https://tokoda.top/api?api=cf27cc2f83ff3ddad2840a7d7e5d9688ab818175&url={url_key}"

#r= requests.get(
#url=api_url,
headers={
"Host":"tokoda.top",
"user-agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.40 Safari/537.36",
"cache-control":"max-age=0",
}





#if r.json()['status'] :
    #linkkey = r.json()["shortenedUrl"]
#else : 
    #link_key = "https://tokoda.top/vkBz1S";
    #key = "8728276";

#print(Colorate.Horizontal(Colors.yellow_to_red,f"{dau} Link Key :  {linkkey} "))

#psss = str(Write.Input(f"{dau} Nhập Key : ", Colors.yellow_to_red, interval=0.01))

#if psss == key :
    #print(Colorate.Horizontal(Colors.yellow_to_red,f"{dau} Key Đúng Rồi "))
    
#else :
    #print(Colorate.Horizontal(Colors.yellow_to_red,f"{dau} Key Sai "))
    #exit()
    

dem=0
banner()
t=(Colorate.Horizontal(Colors.white_to_black,"- - - - - - - - - - - - - - - - - - - - - - - - -"))
VIDEO = str(Write.Input(f"{dau} Nhập Id Videos : ", Colors.yellow_to_red, interval=0.01))
os.system('cls')
print(Colorate.Horizontal(Colors.yellow_to_red,f"{dau}Bản Quyền by: DarlingMquang "))
print(t)
print(Colorate.Horizontal(Colors.yellow_to_red,f"{dau}[1] Views\n{dau}[2] Shares "))
print(t)
type = str(Write.Input(f"{dau}Enter Type : ", Colors.yellow_to_red, interval=0.01))
if type=="1":
 urlb="c2VuZC9mb2xsb3dlcnNfdGlrdG9V"
 hungdepchai="Views successfully sent."
if type=="2":
 urlb="c2VuZC9mb2xsb3dlcnNfdGlrdG9s"
 hungdepchai="Shares successfully sent."
print(t)
from time import sleep
class Main:
    def __init__(self):
        self.url = "https://zefoy.com/"
        self.session = requests.session()
    
    def solve_captcha(self, sessid):
        try:
            # -- get captcha image --
            response = self.session.get(
                self.url + "a1ef290e2636bf553f39817628b6ca49.php",
                headers={
                    "origin": "https://zefoy.com",
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.54 Safari/537.36",
                    "x-requested-with": "XMLHttpRequest",
                    "cookie": f"PHPSESSID={sessid}",
                },
                params={
                    "_CAPTCHA": "",
                    "t": f"{round(random.random(), 8)} {int(time.time())}",
                },
            )
            
            json_data =  {
                "requests": [{
                    "image": {
                        "content": str(base64.b64encode(response.content).decode())
                    },
                    "features": [{"type": "TEXT_DETECTION"}]
                }]
            }

            req = requests.post(
                url = 'https://content-vision.googleapis.com/v1/images:annotate',
                headers = {
                    'x-origin': 'https://explorer.apis.google.com',
                },
                params = {
                    'alt': 'json',
                    'key': 'AIzaSyAa8yy0GdcGPHdtD083HiGGx_S0vMPScDM',
                },
                json = json_data
            )

            captcha_answer = req.json()['responses'][0]["textAnnotations"][0]["description"]

            if captcha_answer == "" or captcha_answer is None:
                self.solve_captcha(sessid)
            
            captcha_answer = re.compile('[^a-zA-Z]').sub('', captcha_answer).lower()

            # submit response
            _response = self.session.post(
                self.url,
                data={
                    "captcha_secure": captcha_answer,
                    "r75619cf53f5a5d7aa6af82edfec3bf0": "",
                },
                headers={
                    "cookie": f"PHPSESSID={sessid}",
                    "origin": "https://zefoy.com",
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.54 Safari/537.36",
                    "x-requested-with": "XMLHttpRequest",
                },
            )
            alpha_key = re.findall('(?<=")[a-z0-9]{16}', _response.text)[0]
            print(Colorate.Horizontal(Colors.yellow_to_red,f"{dau}Giải Captcha [{captcha_answer}] Thành Công"))
            t=(Colorate.Horizontal(Colors.white_to_black,"- - - - - - - - - - - - - - - - - - - - - - - - -"))
            print(t)
            return alpha_key
        except Exception as e:
            print(f"Error: {e}")
            print(Colorate.Horizontal(Colors.yellow_to_red,f"{dau}Lỗi Vui Lòng Giải Captcha "))
            self.solve_captcha(sessid)
            
    def get_sessid(self):
        sessid = self.session.get(
            self.url,
            headers={
                "origin": "https://zefoy.com",
                "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.54 Safari/537.36",
                "x-requested-with": "XMLHttpRequest",
            },
        ).cookies.values()[0]
        return sessid
        
        
        
    def get_view(self):
     sleep(3)
     views = requests.get(
                    url=f"https://api.tiktokv.com/aweme/v1/multi/aweme/detail/?aweme_ids=%5B{VIDEO}%5D",
                    headers={
                        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.54 Safari/537.36"
                    },
                ).json()["aweme_details"][0]["statistics"]["play_count"]
     return views
    def decrypt(self, data):
        return base64.b64decode(urllib.parse.unquote(data[::-1])).decode()

    def decrypt_timer(self, data):
        # decrypted = base64.b64decode(urllib.parse.unquote(data[::-1])).decode()
        if len(re.findall(" \d{3}", data)) != 0:
            timer = re.findall(" \d{3}", data)[0]
        else:
            timer = data.split("= ")[1].split("\n")[0]

        return int(timer)

    def views_loop(self, sessid, alpha_key):
        while True:
            time.sleep(2)
            request = self.session.post(
                self.url +urlb,
                headers={
                    "cookie": f"PHPSESSID={sessid}",
                    "origin": "https://zefoy.com",
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.54 Safari/537.36",
                    "x-requested-with": "XMLHttpRequest",
                },
                data={alpha_key: f"https://www.tiktok.com/@onlp/video/{VIDEO}"},
            )
            decryped_answer = self.decrypt(request.text)

            if "This service is currently not working" in decryped_answer:
                print(Colorate.Horizontal(Colors.yellow_to_red,f"{dau}Chức Năng Đã Bị Close"))
                input()
                sys.exit()
            elif "Server too busy" in decryped_answer:
                print(Colorate.Horizontal(Colors.yellow_to_red,f"{dau} Sever Nghẽn Vui Lòng Chờ "))
                for tt in range(10, 0, -1):
                  print(f"{dau}Loadings...!! | {tt}           ",end="\r")
                  sleep(1)
                continue

            elif "function updatetimer()" in decryped_answer:
                print("\r", end="")
                timer = self.decrypt_timer(decryped_answer)
                for tt in range(timer, 0, -1):
                  print(f"{dau}Loadings...!! | {tt}      ",end="\r")
                  sleep(1)
                continue

            soup = bs4.BeautifulSoup(decryped_answer, "html.parser")
            try:
                beta_key = soup.find("input", {"type": "text"}).get("name")
            except:
                input(decryped_answer)
                sys.exit()

            time.sleep(1)

            start = time.time()
            send_views = requests.post(
                self.url + urlb,
                headers={
                    "cookie": f"PHPSESSID={sessid}",
                    "origin": "https://zefoy.com",
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.54 Safari/537.36",
                    "x-requested-with": "XMLHttpRequest",
                },
                data={beta_key: VIDEO},
            )
            latency = round(time.time() - start, 2)
            dem=0
            while True:
             if latency > 3:
                dem=dem+1
                tg = datetime.now().strftime("%H:%M:%S")
                print(Colorate.Horizontal(Colors.yellow_to_red,f" ~ [{dem}] </> {tg} </> {hungdepchai} </> {VIDEO} "))             
             decrypted_response = self.decrypt(send_views.text)
             
             if "Too many requests. Please slow down." in decrypted_response:
                print("Ratelimited")
                time.sleep(120)
                continue
             timer = self.decrypt_timer(decrypted_response)
             for tt in range(timer, 0, -1):
              print(f"{dau}Loadings...!! | {tt}              ",end="\r")
              sleep(1)
    def main(self):
        sessid = self.get_sessid()
        alpha_key: str = self.solve_captcha(sessid)
        self.views_loop(sessid, alpha_key)
if __name__ == "__main__":
    Main().main()
